<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odin Streamer - Dynamic Subscription Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        input, button, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .market-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .stock-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: white;
        }
        .stock-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        .stock-price {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        .stock-change {
            font-size: 14px;
            margin-left: 10px;
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .stock-details {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .week52-alert {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        .subscription-list {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .quick-stocks {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .quick-stock {
            background-color: #e9ecef;
            border: 1px solid #adb5bd;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .quick-stock:hover {
            background-color: #dee2e6;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ Odin Streamer - Dynamic Subscription Test</h1>
    
    <div class="container">
        <h2>Connection Status</h2>
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div class="controls">
            <input type="text" id="serverUrl" value="ws://localhost:8080/live-stream" placeholder="WebSocket URL">
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <div class="container">
        <h2>Dynamic Subscription Management</h2>
        
        <div class="controls">
            <input type="text" id="stockSymbol" placeholder="Stock Symbol (e.g., AERO, RELIANCE)" style="flex: 1;">
            <button onclick="subscribeStock()">Subscribe</button>
            <button onclick="unsubscribeStock()">Unsubscribe</button>
            <button onclick="listSubscriptions()">List Subscriptions</button>
        </div>

        <div class="controls">
            <input type="text" id="multipleStocks" placeholder="Multiple stocks (comma-separated)" style="flex: 1;">
            <button onclick="subscribeMultiple()">Subscribe Multiple</button>
            <button onclick="unsubscribeMultiple()">Unsubscribe Multiple</button>
        </div>

        <div class="quick-stocks">
            <strong>Quick Subscribe:</strong>
            <span class="quick-stock" onclick="quickSubscribe('AERO')">AERO</span>
            <span class="quick-stock" onclick="quickSubscribe('RELIANCE')">RELIANCE</span>
            <span class="quick-stock" onclick="quickSubscribe('TCS')">TCS</span>
            <span class="quick-stock" onclick="quickSubscribe('INFY')">INFY</span>
            <span class="quick-stock" onclick="quickSubscribe('HDFC')">HDFC</span>
            <span class="quick-stock" onclick="quickSubscribe('ICICIBANK')">ICICIBANK</span>
            <span class="quick-stock" onclick="quickSubscribe('SBIN')">SBIN</span>
            <span class="quick-stock" onclick="quickSubscribe('ITC')">ITC</span>
        </div>

        <div id="subscriptionList" class="subscription-list">
            <strong>Current Subscriptions:</strong> None
        </div>
    </div>

    <div class="container">
        <h2>Live Market Data</h2>
        <div id="marketData" class="market-data">
            <p>No market data received yet. Subscribe to stocks to see live data.</p>
        </div>
    </div>

    <div class="container">
        <h2>Message Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        let ws = null;
        let subscriptions = new Set();
        let marketDataMap = new Map();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function connect() {
            const url = document.getElementById('serverUrl').value;
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = function(event) {
                    log('Connected to Odin Streamer', 'success');
                    updateStatus(true);
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) {
                        log('Error parsing message: ' + e.message, 'error');
                    }
                };
                
                ws.onclose = function(event) {
                    log('Connection closed: ' + event.code + ' - ' + event.reason, 'warning');
                    updateStatus(false);
                    ws = null;
                };
                
                ws.onerror = function(error) {
                    log('WebSocket error: ' + error, 'error');
                    updateStatus(false);
                };
                
            } catch (e) {
                log('Connection failed: ' + e.message, 'error');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                log('Sent: ' + JSON.stringify(message));
            } else {
                log('Not connected to server', 'error');
            }
        }

        function subscribeStock() {
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            if (!symbol) {
                log('Please enter a stock symbol', 'warning');
                return;
            }
            
            sendMessage({
                type: 'subscribe',
                symbol: symbol
            });
        }

        function unsubscribeStock() {
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            if (!symbol) {
                log('Please enter a stock symbol', 'warning');
                return;
            }
            
            sendMessage({
                type: 'unsubscribe',
                symbol: symbol
            });
        }

        function subscribeMultiple() {
            const stocks = document.getElementById('multipleStocks').value.trim();
            if (!stocks) {
                log('Please enter stock symbols', 'warning');
                return;
            }
            
            const stockList = stocks.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            
            sendMessage({
                type: 'subscribe',
                stocks: stockList
            });
        }

        function unsubscribeMultiple() {
            const stocks = document.getElementById('multipleStocks').value.trim();
            if (!stocks) {
                log('Please enter stock symbols', 'warning');
                return;
            }
            
            const stockList = stocks.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            
            sendMessage({
                type: 'unsubscribe',
                stocks: stockList
            });
        }

        function quickSubscribe(symbol) {
            document.getElementById('stockSymbol').value = symbol;
            subscribeStock();
        }

        function listSubscriptions() {
            sendMessage({
                type: 'list_subscriptions'
            });
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'welcome':
                    log('Welcome message: ' + JSON.stringify(data.data), 'success');
                    break;
                    
                case 'pong':
                    log('Pong received');
                    break;
                    
                case 'subscribe_response':
                case 'unsubscribe_response':
                    handleSubscriptionResponse(data);
                    break;
                    
                case 'subscription_list':
                    handleSubscriptionList(data);
                    break;
                    
                case 'live_market_data':
                    handleMarketData(data);
                    break;
                    
                case 'new_52_week_high':
                case 'new_52_week_low':
                case 'new_52_week_high_low':
                    handle52WeekRecord(data);
                    break;
                    
                default:
                    log('Unknown message type: ' + data.type, 'warning');
                    log('Message: ' + JSON.stringify(data));
            }
        }

        function handleSubscriptionResponse(data) {
            if (data.success) {
                log(`${data.type}: ${data.message}`, 'success');
                if (data.subscribed && data.subscribed.length > 0) {
                    log(`Successfully processed: ${data.subscribed.join(', ')}`, 'success');
                    
                    // Update local subscription set
                    if (data.type === 'subscribe_response') {
                        data.subscribed.forEach(stock => subscriptions.add(stock));
                    } else {
                        data.subscribed.forEach(stock => subscriptions.delete(stock));
                    }
                }
                if (data.failed && data.failed.length > 0) {
                    log(`Failed: ${data.failed.join(', ')}`, 'warning');
                }
                log(`Total subscriptions: ${data.total_count}`, 'info');
            } else {
                log(`${data.type}: ${data.message}`, 'error');
            }
            
            updateSubscriptionDisplay();
        }

        function handleSubscriptionList(data) {
            subscriptions.clear();
            if (data.subscribed) {
                data.subscribed.forEach(stock => subscriptions.add(stock));
            }
            log(`Current subscriptions (${data.total_count}): ${data.subscribed ? data.subscribed.join(', ') : 'None'}`, 'info');
            updateSubscriptionDisplay();
        }

        function updateSubscriptionDisplay() {
            const listDiv = document.getElementById('subscriptionList');
            if (subscriptions.size > 0) {
                listDiv.innerHTML = `<strong>Current Subscriptions (${subscriptions.size}):</strong> ${Array.from(subscriptions).join(', ')}`;
            } else {
                listDiv.innerHTML = '<strong>Current Subscriptions:</strong> None';
            }
        }

        function handleMarketData(data) {
            const marketData = data.data;
            marketDataMap.set(marketData.symbol, marketData);
            updateMarketDataDisplay();
        }

        function handle52WeekRecord(data) {
            const marketData = data.data;
            let alertType = '';
            
            if (data.type === 'new_52_week_high') {
                alertType = 'ðŸš€ NEW 52-WEEK HIGH!';
            } else if (data.type === 'new_52_week_low') {
                alertType = 'ðŸ“‰ NEW 52-WEEK LOW!';
            } else {
                alertType = 'ðŸŽ¯ NEW 52-WEEK HIGH & LOW!';
            }
            
            log(`${alertType} ${marketData.symbol}: â‚¹${marketData.ltp}`, 'success');
            
            // Update market data
            marketDataMap.set(marketData.symbol, marketData);
            updateMarketDataDisplay();
        }

        function updateMarketDataDisplay() {
            const container = document.getElementById('marketData');
            
            if (marketDataMap.size === 0) {
                container.innerHTML = '<p>No market data received yet. Subscribe to stocks to see live data.</p>';
                return;
            }
            
            let html = '';
            marketDataMap.forEach((data, symbol) => {
                const changeClass = data.percent_change >= 0 ? 'positive' : 'negative';
                const changeSymbol = data.percent_change >= 0 ? '+' : '';
                
                let week52Alert = '';
                if (data.is_new_week_52_high || data.is_new_week_52_low) {
                    let alertText = '';
                    if (data.is_new_week_52_high && data.is_new_week_52_low) {
                        alertText = 'ðŸŽ¯ NEW 52-WEEK HIGH & LOW!';
                    } else if (data.is_new_week_52_high) {
                        alertText = 'ðŸš€ NEW 52-WEEK HIGH!';
                    } else {
                        alertText = 'ðŸ“‰ NEW 52-WEEK LOW!';
                    }
                    week52Alert = `<div class="week52-alert">${alertText}</div>`;
                }
                
                html += `
                    <div class="stock-card">
                        <div class="stock-header">${symbol} (${data.exchange})</div>
                        <div class="stock-price">
                            â‚¹${data.ltp.toFixed(2)}
                            <span class="stock-change ${changeClass}">
                                ${changeSymbol}${data.percent_change.toFixed(2)}%
                            </span>
                        </div>
                        ${week52Alert}
                        <div class="stock-details">
                            <div><strong>Day Range:</strong> â‚¹${data.low} - â‚¹${data.high}</div>
                            <div><strong>52W Range:</strong> â‚¹${data.week_52_low} - â‚¹${data.week_52_high}</div>
                            <div><strong>Volume:</strong> ${data.volume.toLocaleString()}</div>
                            <div><strong>Open:</strong> â‚¹${data.open} | <strong>Prev Close:</strong> â‚¹${data.prev_close}</div>
                            <div><strong>Last Updated:</strong> ${new Date(data.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Send ping every 30 seconds to keep connection alive
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendMessage({ type: 'ping' });
            }
        }, 30000);

        // Auto-connect on page load
        window.onload = function() {
            log('Page loaded. Click Connect to start testing dynamic subscriptions.', 'info');
        };
    </script>
</body>
</html>
